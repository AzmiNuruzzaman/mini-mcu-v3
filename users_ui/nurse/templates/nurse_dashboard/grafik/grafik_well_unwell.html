<div id="well-unwell-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if grafik_subtab != 'well_unwell' %}hidden{% endif %}">
  <h2 class="text-xl font-bold mb-3">Distribusi Well &amp; Unwell</h2>

  <div class="mb-4 flex items-center gap-2">
    <label for="wu-month" class="font-medium">Bulan:</label>
    <input type="month" id="wu-month" class="border px-2 py-1 rounded" value="{{ request.GET.month|default:'' }}"/>

    <label for="wu-lokasi" class="font-medium ml-2">Lokasi Kerja:</label>
    <select id="wu-lokasi" class="border px-2 py-1 rounded">
      <option value="">Semua Lokasi</option>
      {% if available_lokasi %}
        {% for lk in available_lokasi %}
          {% if lk %}
          <option value="{{ lk }}">{{ lk }}</option>
          {% endif %}
        {% endfor %}
      {% endif %}
    </select>

    <button id="wu-refresh" class="ml-2 bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Terapkan</button>
  </div>

  <div id="wellUnwellChart" class="w-full min-h-[320px]"></div>
</div>

<script>
(function(){
  // Only initialize if subtab is active
  const container = document.getElementById('well-unwell-content');
  if (!container || container.classList.contains('hidden')) return;

  const monthInput = document.getElementById('wu-month');
  const lokasiSelect = document.getElementById('wu-lokasi');
  const refreshBtn = document.getElementById('wu-refresh');
  const chartDiv = document.getElementById('wellUnwellChart');
  const endpoint = "{% url 'nurse:well_unwell_summary_json' %}";

  // Default month to current if empty
  if (monthInput && !monthInput.value) {
    const d = new Date();
    const m = String(d.getMonth()+1).padStart(2,'0');
    monthInput.value = `${d.getFullYear()}-${m}`;
  }

  async function fetchData() {
    const params = new URLSearchParams();
    const month = monthInput.value;
    const lokasi = lokasiSelect.value;
    // Nurse endpoint expects a month range; use the same month for from/to
    if (month) {
      params.set('month_from', month);
      params.set('month_to', month);
    }
    if (lokasi) params.set('lokasi', lokasi);

    const url = `${endpoint}?${params.toString()}`;
    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      const data = await res.json();
      if (data.error) {
        console.error('API error:', data.error);
        return;
      }
      renderChart(data);
    } catch (e) {
      console.error('Failed to fetch Well/Unwell data', e);
    }
  }

  function renderChart(data) {
    // Expect nurse endpoint shape: [{ month: 'YYYY-MM', well: N, unwell: M }, ...]
    const months = (data || []).map(d => d.month);
    const wellCounts = (data || []).map(d => d.well);
    const unwellCounts = (data || []).map(d => d.unwell);

    const wellTrace = {
      x: months,
      y: wellCounts,
      name: 'Well',
      type: 'bar',
      marker: { color: '#22c55e' },
      hovertemplate: 'Bulan: %{x}<br>Status: Well<br>Total: %{y} karyawan<extra></extra>'
    };

    const unwellTrace = {
      x: months,
      y: unwellCounts,
      name: 'Unwell',
      type: 'bar',
      marker: { color: '#ef4444' },
      hovertemplate: 'Bulan: %{x}<br>Status: Unwell<br>Total: %{y} karyawan<extra></extra>'
    };

    const layout = {
      title: 'Well vs Unwell Over Time',
      xaxis: { title: 'Periode (Bulan)' },
      yaxis: { title: 'Jumlah Karyawan', rangemode: 'tozero' },
      barmode: 'group',
      margin: { t: 60, r: 40, b: 60, l: 70 },
      height: 360,
      plot_bgcolor: 'rgba(0,0,0,0)',
      paper_bgcolor: 'rgba(0,0,0,0)'
    };

    Plotly.newPlot(chartDiv, [wellTrace, unwellTrace], layout, {responsive: true});
  }

  function bindEvents() {
    if (refreshBtn) refreshBtn.addEventListener('click', fetchData);
    if (monthInput) monthInput.addEventListener('change', fetchData);
    if (lokasiSelect) lokasiSelect.addEventListener('change', fetchData);
  }

  bindEvents();
  fetchData();
})();
</script>
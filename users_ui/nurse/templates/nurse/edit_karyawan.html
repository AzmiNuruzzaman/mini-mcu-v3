{% extends "nurse/nurse_index.html" %}
{% load static %}

{% block title %}Nurse Dashboard - {{ active_menu_label }}{% endblock %}

{% block page_content %}
<div class="bg-white rounded-lg shadow-md p-6">
  <!-- Submenu Navigation -->
  <div class="flex gap-6 mb-4 px-3 pt-3 border-b border-slate-300 bg-white rounded-t-xl shadow-sm">
      <a href="?submenu=edit" 
         class="hidden pb-3 px-4 font-medium text-gray-700 hover:text-blue-600 transition-colors
                {% if active_submenu == 'edit' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
          Karyawan Profile
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=data_karyawan{% else %}?submenu=data_karyawan{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'data_karyawan' %}bg-blue-600 text-white border-blue-600{% endif %}">
          Data Karyawan
      </a>
      <a href="?submenu=edit_data" 
         class="hidden pb-3 px-4 font-medium text-gray-700 hover:text-blue-600 transition-colors
                {% if active_submenu == 'edit_data' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
          Edit Data Checkup
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=history{% else %}?submenu=history{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'history' %}bg-blue-600 text-white border-blue-600{% endif %}">
          History Medical Check Up
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=grafik{% else %}?submenu=grafik{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'grafik' %}bg-blue-600 text-white border-blue-600{% endif %}">
          Grafik
      </a>
  </div>

  {% if active_submenu == 'data_karyawan' %}
  <!-- Inner tabs under Data Karyawan -->
  <div class="flex gap-2 mb-4 px-3 pt-3 border-b border-slate-300 bg-white rounded-t-md shadow-sm overflow-x-auto whitespace-nowrap">
      <a href="?submenu=data_karyawan&subtab=profile" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'profile' %}bg-green-600 text-white border-green-600{% endif %}">
          Karyawan Profile
      </a>
      <a href="?submenu=data_karyawan&subtab=edit_data" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'edit_data' %}bg-green-600 text-white border-green-600{% endif %}">
          Edit Data Checkup
      </a>
  </div>
  {% endif %}

  <!-- Edit Data Karyawan Content (now shown under Data Karyawan > Karyawan Profile) -->
  {% if active_submenu == 'data_karyawan' and active_subtab == 'profile' %}
  <div id="edit-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4">
      <h2 class="text-xl font-bold mb-3">Edit Karyawan</h2>

      <!-- 1. Selector box by nama on the top -->
      <form method="get" class="mb-4">
        <input type="hidden" name="submenu" value="data_karyawan"/>
        <input type="hidden" name="subtab" value="profile"/>
        <label for="uid" class="block mb-2 font-medium">Pilih Karyawan (Nama):</label>
        <select name="uid" id="uid" class="select2 border px-2 py-1 rounded w-full" onchange="this.form.submit()">
          {% for e in employees %}
            <option value="{{ e.uid }}" {% if employee.uid == e.uid %}selected{% endif %}>{{ e.nama }}</option>
          {% endfor %}
        </select>
      </form>

      <!-- 2. Dataframe style display karyawan info with editable kontak darurat -->
      <section class="p-4 bg-white shadow rounded">
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2 text-left">Field</th>
                <th class="border px-4 py-2 text-left">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-4 py-2">Nama</td>
                <td class="border px-4 py-2">{{ employee.nama }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">UID</td>
                <td class="border px-4 py-2"><span class="font-mono">{{ employee.uid }}</span></td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Jabatan</td>
                <td class="border px-4 py-2">{{ employee.jabatan }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Lokasi</td>
                <td class="border px-4 py-2">{{ employee.lokasi }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Tanggal Lahir</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.tanggal_lahir %}
                    {{ latest_checkup.tanggal_lahir }}
                  {% elif employee.tanggal_lahir %}
                    {{ employee.tanggal_lahir }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="hidden">
                <td class="border px-4 py-2">Umur</td>
                <td class="border px-4 py-2">{% if latest_checkup and latest_checkup.umur %}{{ latest_checkup.umur }}{% else %}-{% endif %}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Derajat Kesehatan</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.derajat_kesehatan %}
                    {% with dk=latest_checkup.derajat_kesehatan|upper %}
                      {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                        <span class="text-green-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P4" %}
                        <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P5" %}
                        <span class="text-orange-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P6" or dk == "P7" %}
                        <span class="text-red-600 font-semibold">{{ dk }}</span>
                      {% elif dk %}
                        <span class="text-gray-700 font-semibold">{{ dk }}</span>
                      {% else %}
                        <span class="text-gray-400 italic">-</span>
                      {% endif %}
                    {% endwith %}
                  {% elif employee.derajat_kesehatan %}
                    {% with dk=employee.derajat_kesehatan|upper %}
                      {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                        <span class="text-green-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P4" %}
                        <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P5" %}
                        <span class="text-orange-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P6" or dk == "P7" %}
                        <span class="text-red-600 font-semibold">{{ dk }}</span>
                      {% elif dk %}
                        <span class="text-gray-700 font-semibold">{{ dk }}</span>
                      {% else %}
                        <span class="text-gray-400 italic">-</span>
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    <span class="text-gray-400 italic">-</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Berat</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.berat %}
                    {{ latest_checkup.berat }}
                  {% elif employee.berat %}
                    {{ employee.berat }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Tinggi</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.tinggi %}
                    {{ latest_checkup.tinggi }}
                  {% elif employee.tinggi %}
                    {{ employee.tinggi }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">BMI</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.bmi %}
                    {{ latest_checkup.bmi }}
                  {% elif employee.bmi %}
                    {{ employee.bmi }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">BMI Category</td>
                <td class="border px-4 py-2">{{ employee.bmi_category|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Kontak Darurat</td>
                <td class="border px-4 py-2">
                  {% if not view_only %}
                  <form method="post" action="{% url 'nurse:karyawan_detail' employee.uid %}?submenu=edit" class="flex items-center gap-2">
                    {% csrf_token %}
                    <input type="text" name="kontak_darurat" value="{{ employee.kontak_darurat|default:'' }}" placeholder="Masukkan kontak darurat" class="border px-2 py-1 rounded w-full"/>
                    <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Simpan</button>
                  </form>
                  {% else %}
                    {{ employee.kontak_darurat|default:"-" }}
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- MCU DataFrame -->
        <div class="mt-6 p-4 bg-white shadow rounded">
          <h3 class="text-lg font-semibold mb-3">MCU</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse border border-gray-300">
              <thead>
                <tr class="bg-gray-100">
                  <th class="border px-4 py-2 text-left">Field</th>
                  <th class="border px-4 py-2 text-left">Value</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="border px-4 py-2">Tanggal MCU</td>
                  <td class="border px-4 py-2">{{ employee.tanggal_MCU|default:"-" }}</td>
                </tr>
                <tr>
                  <td class="border px-4 py-2">Expired MCU</td>
                  <td class="border px-4 py-2">{{ employee.expired_MCU|default:"-" }}</td>
                </tr>
                <tr>
                  <td class="border px-4 py-2">Estimasi Hari ke Expired</td>
                  <td class="border px-4 py-2">{{ mcu_expiry_estimate|default:"-" }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 3. Latest Medical Checkup (DataFrame-style) -->
      <section class="mt-6 p-4 bg-white shadow rounded">
        <h3 class="text-lg font-semibold mb-3">Data Checkup Terakhir</h3>
        {% if latest_checkup %}
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2 text-left">Field</th>
                <th class="border px-4 py-2 text-left">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-4 py-2">Tanggal Checkup</td>
                <td class="border px-4 py-2">{{ latest_checkup.tanggal_checkup }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Puasa</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.gdp_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.gula_darah_puasa|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Sewaktu</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.gds_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.gula_darah_sewaktu|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Cholesterol</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.chol_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.cholesterol|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Asam Urat</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.asam_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.asam_urat|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Derajat Kesehatan</td>
                <td class="border px-4 py-2">
                  {% with dk=latest_checkup.derajat_kesehatan|default:""|upper %}
                    {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                      <span class="text-green-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P4" %}
                      <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P5" %}
                      <span class="text-orange-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P6" or dk == "P7" %}
                      <span class="text-red-600 font-semibold">{{ dk }}</span>
                    {% elif dk %}
                      <span class="text-gray-700 font-semibold">{{ dk }}</span>
                    {% else %}
                      <span class="text-gray-400 italic">-</span>
                    {% endif %}
                  {% endwith %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Lingkar Perut (cm)</td>
                <td class="border px-4 py-2">{{ latest_checkup.lingkar_perut|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Status</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.status %}
                    <span class="inline-block px-2 py-1 rounded text-white {% if latest_checkup.status == 'Unwell' %}bg-red-500{% else %}bg-green-500{% endif %}">{{ latest_checkup.status }}</span>
                  {% else %}
                    <span class="text-gray-500">-</span>
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-4 bg-gray-50 border rounded text-gray-500">Belum ada data medical checkup.</div>
        {% endif %}
      </section>
   </div>
   {% endif %}

  <!-- Edit Karyawan Data Content (empty; now under Data Karyawan > Edit Karyawan Data) -->
   {% if active_submenu == 'data_karyawan' and active_subtab == 'edit_data' %}
   <div id="edit-data-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4">
      <h2 class="text-xl font-bold mb-3">Edit Data Checkup</h2>
      <div class="mb-2">
         <span class="text-sm text-green-600 font-semibold cursor-help" title="Pilih karyawan di tab Karyawan Profile">Pilih karyawan di tab Karyawan Profile</span>
      </div>
      <!-- Removed duplicate Karyawan name label as it's already shown in the container/header -->
      {% include 'nurse/partials/edit_karyawan_form.html' with karyawan=employee %}
   </div>
   {% endif %}

  <!-- History Medical Check Up Content -->
   {% if active_submenu == 'history' %}
   <div id="history-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4">
      <h2 class="text-xl font-bold mb-3">History Medical Check Up</h2>
      <a href="{% url 'nurse:export_checkup_history_by_uid' employee.uid %}" class="inline-flex items-center bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 mb-3">Download seluruh riwayat (XLS)</a>
      <a href="{% url 'nurse:export_checkup_history_by_uid_pdf' employee.uid %}" class="inline-flex items-center bg-yellow-600 text-white px-3 py-2 rounded hover:bg-yellow-700 mb-3 ml-2">Download seluruh riwayat (PDF)</a>
      {% if history_dashboard and history_dashboard|length > 0 %}

      {% csrf_token %}
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white editable-table">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Lahir</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umur</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BMI</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BMI Category</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Checkup</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lingkar Perut</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gula Darah Puasa</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gula Darah Sewaktu</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cholesterol</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asam Urat</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tekanan Darah</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derajat Kesehatan</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal MCU</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expired MCU</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for row in history_dashboard %}
            <tr data-checkup-id="{{ row.checkup_id }}">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ forloop.counter }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.uid }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.nama|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.jabatan|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.lokasi|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tanggal_lahir|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" id="umur-{{ row.checkup_id }}" value="{{ row.umur|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="bmi-{{ row.checkup_id }}" value="{{ row.bmi|default:'' }}" class="w-24 border px-2 py-1 rounded {% if row.flags and row.flags.bmi_high %}text-red-600 font-semibold{% endif %}" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if row.bmi is not None %}
                  {% if row.bmi < 18.5 %}Underweight{% elif row.bmi < 25 %}Normal{% elif row.bmi < 30 %}Overweight{% else %}Obese{% endif %}
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" id="tanggal_checkup-{{ row.checkup_id }}" value="{{ row.tanggal_checkup|default:'' }}" placeholder="dd/mm/yy atau yyyy-mm-dd" class="w-32 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="lingkar_perut-{{ row.checkup_id }}" value="{{ row.lingkar_perut|default:'' }}" disabled class="w-24 border px-2 py-1 rounded">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="gula_darah_puasa-{{ row.checkup_id }}" value="{{ row.gula_darah_puasa|default:'' }}" disabled class="w-24 border px-2 py-1 rounded {% if row.flags and row.flags.gdp_high %}text-red-600 font-semibold{% endif %}">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="gula_darah_sewaktu-{{ row.checkup_id }}" value="{{ row.gula_darah_sewaktu|default:'' }}" disabled class="w-24 border px-2 py-1 rounded {% if row.flags and row.flags.gds_high %}text-red-600 font-semibold{% endif %}">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="cholesterol-{{ row.checkup_id }}" value="{{ row.cholesterol|default:'' }}" disabled class="w-24 border px-2 py-1 rounded {% if row.flags and row.flags.chol_high %}text-red-600 font-semibold{% endif %}">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="asam_urat-{{ row.checkup_id }}" value="{{ row.asam_urat|default:'' }}" disabled class="w-24 border px-2 py-1 rounded {% if row.flags and row.flags.asam_high %}text-red-600 font-semibold{% endif %}">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" id="tekanan_darah-{{ row.checkup_id }}" value="{{ row.tekanan_darah|default:'' }}" disabled class="w-28 border px-2 py-1 rounded">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" id="derajat_kesehatan-{{ row.checkup_id }}" value="{{ row.derajat_kesehatan|default:'' }}" disabled class="w-20 border px-2 py-1 rounded">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tanggal_MCU|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.expired_MCU|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if row.status == "Unwell" %}
                  <span class="text-red-600 font-semibold">Unwell</span>
                {% elif row.status == "Well" %}
                  <span class="text-green-600 font-semibold">Well</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex gap-2">
                  {% if row.checkup_id %}
                  <a href="{% url 'nurse:export_checkup_row' employee.uid row.checkup_id %}" class="inline-flex items-center bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" title="Download baris ini">XLS</a>
                  <a href="{% url 'nurse:export_checkup_row_pdf' employee.uid row.checkup_id %}" class="inline-flex items-center bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 ml-2" title="Download baris ini (PDF)">PDF</a>
                  <a href="{% url 'nurse:delete_checkup' row.checkup_id %}?uid={{ employee.uid }}&submenu=history" class="inline-flex items-center bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 ml-2" onclick="return confirm('Hapus checkup ini?');" title="Hapus baris ini">Hapus</a>
                  {% if not view_only %}
                  <button type="button" id="editbtn-{{ row.checkup_id }}" onclick="toggleEditRow('{{ row.checkup_id }}')" class="inline-flex items-center bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 ml-2">Edit</button>
                  <button type="button" id="savebtn-{{ row.checkup_id }}" onclick="submitEditRow('{{ row.checkup_id }}')" class="inline-flex items-center bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 ml-2 hidden">Save</button>
                  {% endif %}
                  {% else %}
                    <span class="text-gray-400 italic">-</span>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="p-4 bg-gray-50 border rounded text-gray-500">
          Belum ada data medical checkup.
        </div>
      {% endif %}
   </div>
   {% endif %}

  {% if active_submenu == 'grafik' %}
  <!-- Grafik Content -->
  <div id="grafik-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4">
      <h2 class="text-xl font-bold mb-3">Grafik</h2>
      <form method="get" class="mb-4 flex items-center gap-2">
        <input type="hidden" name="submenu" value="grafik"/>
        <label class="font-medium">Range Bulan:</label>
        <input type="month" name="start_month" value="{{ grafik_start_month }}" class="border px-2 py-1 rounded">
        <span class="mx-1">s/d</span>
        <input type="month" name="end_month" value="{{ grafik_end_month }}" class="border px-2 py-1 rounded">
        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Terapkan</button>
      </form>
      {% if grafik_chart_html %}
        <div class="w-full overflow-x-auto">
          {{ grafik_chart_html|safe }}
        </div>
        <script>
          document.addEventListener('DOMContentLoaded', function(){
            var grafContainer = document.querySelector('#grafik-content .plotly-graph-div');
            if (!grafContainer || typeof Plotly === 'undefined' || !Plotly.relayout) return;
            const thresholdValues = {
              'Gula Darah Puasa': 126,
              'Gula Darah Sewaktu': 200,
              'Asam Urat': 7,
              'Cholesterol': 200,
              'BMI': 30
            };
            grafContainer.on('plotly_legendclick', function(ev){
              try {
                var idx = ev.curveNumber;
                var d = ev.data || (ev.fullData || []);
                var name = (d && d[idx] && d[idx].name) ? d[idx].name : null;
                if (!name) return true;
                var thr = thresholdValues[name];
                var shapes = [];
                if (thr != null) {
                  shapes = [{ type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: thr, y1: thr, line: { color: 'rgba(255,0,0,0.35)', width: 2, dash: 'dash' } }];
                }
                Plotly.relayout(grafContainer, { shapes: shapes, 'yaxis.showticklabels': true });
              } catch(e) {}
              return true;
            });
            grafContainer.on('plotly_click', function(ev){
              try {
                var pt = ev.points && ev.points[0];
                var name = pt && pt.data && pt.data.name;
                var thr = thresholdValues[name];
                if (thr == null) return;
                var shape = { type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: thr, y1: thr, line: { color: 'rgba(255,0,0,0.35)', width: 2, dash: 'dash' } };
                Plotly.relayout(grafContainer, { shapes: [shape], 'yaxis.showticklabels': true });
              } catch(e) {}
            });
          });
        </script>
      {% else %}
        <div class="p-4 bg-gray-50 border rounded text-gray-500">Belum ada data grafik untuk range ini.</div>
      {% endif %}
  </div>
  {% endif %}
</div>
{% load static %}
<script src="{% static 'users_ui/nurse/js/edit_karyawan.js' %}"></script>
{% endblock %}

<script>


function toggleEditRow(id) {
  const inputs = document.querySelectorAll(`[id$="-${id}"]`);
  inputs.forEach(inp => inp.disabled = false);
  const editBtn = document.getElementById(`editbtn-${id}`);
  const saveBtn = document.getElementById(`savebtn-${id}`);
  if (editBtn) editBtn.classList.add("hidden");
  if (saveBtn) saveBtn.classList.remove("hidden");
}

function submitEditRow(id) {
  const form = document.createElement("form");
  form.method = "POST";
  form.action = window.location.pathname + window.location.search;
  form.innerHTML = `
    <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
    <input type="hidden" name="action" value="edit_row">
    <input type="hidden" name="checkup_id" value="${id}">
    <input type="hidden" name="save_changes" value="1">
  `;
  const fields = ["tanggal_checkup","lingkar_perut","gula_darah_puasa","gula_darah_sewaktu","cholesterol","asam_urat","tekanan_darah","derajat_kesehatan"];
  fields.forEach(f => {
    const el = document.getElementById(`${f}-${id}`);
    const val = el ? el.value : "";
    form.innerHTML += `<input type="hidden" name="${f}" value="${val}">`;
  });
  document.body.appendChild(form);
  form.submit();
}
</script>

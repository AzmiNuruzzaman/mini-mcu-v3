{% extends "nurse/nurse_index.html" %}
{% load static %}

{% block title %}Nurse Dashboard - {{ active_menu_label }}{% endblock %}

{% block page_content %}
<div class="bg-white rounded-lg shadow-md p-6">
  <!-- Submenu Navigation -->
  <div class="flex gap-6 mb-4 px-3 pt-3 border-b border-slate-300 bg-white rounded-t-xl shadow-sm">
      <a href="?submenu=edit" 
         class="hidden pb-3 px-4 font-medium text-gray-700 hover:text-blue-600 transition-colors
                {% if active_submenu == 'edit' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
          Karyawan Profile
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=data_karyawan{% else %}?submenu=data_karyawan{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'data_karyawan' %}bg-blue-600 text-white border-blue-600{% endif %}">
          Data Karyawan
      </a>
      <a href="?submenu=edit_data" 
         class="hidden pb-3 px-4 font-medium text-gray-700 hover:text-blue-600 transition-colors
                {% if active_submenu == 'edit_data' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
          Edit Data Checkup
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=history{% else %}?submenu=history{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'history' %}bg-blue-600 text-white border-blue-600{% endif %}">
          History Medical Check Up
      </a>
  </div>

  {% if active_submenu == 'data_karyawan' %}
  <!-- Inner tabs under Data Karyawan -->
  <div class="flex gap-2 mb-4 px-3 pt-3 border-b border-slate-300 bg-white rounded-t-md shadow-sm overflow-x-auto whitespace-nowrap">
      <a href="?submenu=data_karyawan&subtab=profile" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'profile' %}bg-green-600 text-white border-green-600{% endif %}">
          Karyawan Profile
      </a>
      <a href="?submenu=data_karyawan&subtab=edit_data" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'edit_data' %}bg-green-600 text-white border-green-600{% endif %}">
          Edit Data Checkup
      </a>
  </div>
  {% endif %}

  <!-- Edit Data Karyawan Content (now shown under Data Karyawan > Karyawan Profile) -->
  <div id="edit-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'data_karyawan' or active_subtab != 'profile' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Edit Karyawan</h2>

      <!-- 1. Selector box by nama on the top -->
      <form method="get" class="mb-4">
        <input type="hidden" name="submenu" value="data_karyawan"/>
        <input type="hidden" name="subtab" value="profile"/>
        <label for="uid" class="block mb-2 font-medium">Pilih Karyawan (Nama):</label>
        <select name="uid" id="uid" class="select2 border px-2 py-1 rounded w-full" onchange="this.form.submit()">
          {% for e in employees %}
            <option value="{{ e.uid }}" {% if employee.uid == e.uid %}selected{% endif %}>{{ e.nama }}</option>
          {% endfor %}
        </select>
      </form>

      <!-- 2. Dataframe style display karyawan info with editable kontak darurat -->
      <section class="p-4 bg-white shadow rounded">
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2 text-left">Field</th>
                <th class="border px-4 py-2 text-left">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-4 py-2">Nama</td>
                <td class="border px-4 py-2">{{ employee.nama }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">UID</td>
                <td class="border px-4 py-2"><span class="font-mono">{{ employee.uid }}</span></td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Jabatan</td>
                <td class="border px-4 py-2">{{ employee.jabatan }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Lokasi</td>
                <td class="border px-4 py-2">{{ employee.lokasi }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Tanggal Lahir</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.tanggal_lahir %}
                    {{ latest_checkup.tanggal_lahir }}
                  {% elif employee.tanggal_lahir %}
                    {{ employee.tanggal_lahir }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="hidden">
                <td class="border px-4 py-2">Umur</td>
                <td class="border px-4 py-2">{% if latest_checkup and latest_checkup.umur %}{{ latest_checkup.umur }}{% else %}-{% endif %}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Derajat Kesehatan</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.derajat_kesehatan %}
                    {% with dk=latest_checkup.derajat_kesehatan|upper %}
                      {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                        <span class="text-green-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P4" %}
                        <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P5" %}
                        <span class="text-orange-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P6" or dk == "P7" %}
                        <span class="text-red-600 font-semibold">{{ dk }}</span>
                      {% elif dk %}
                        <span class="text-gray-700 font-semibold">{{ dk }}</span>
                      {% else %}
                        <span class="text-gray-400 italic">-</span>
                      {% endif %}
                    {% endwith %}
                  {% elif employee.derajat_kesehatan %}
                    {% with dk=employee.derajat_kesehatan|upper %}
                      {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                        <span class="text-green-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P4" %}
                        <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P5" %}
                        <span class="text-orange-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P6" or dk == "P7" %}
                        <span class="text-red-600 font-semibold">{{ dk }}</span>
                      {% elif dk %}
                        <span class="text-gray-700 font-semibold">{{ dk }}</span>
                      {% else %}
                        <span class="text-gray-400 italic">-</span>
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    <span class="text-gray-400 italic">-</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Berat</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.berat %}
                    {{ latest_checkup.berat }}
                  {% elif employee.berat %}
                    {{ employee.berat }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Tinggi</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.tinggi %}
                    {{ latest_checkup.tinggi }}
                  {% elif employee.tinggi %}
                    {{ employee.tinggi }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">BMI</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.bmi %}
                    {{ latest_checkup.bmi }}
                  {% elif employee.bmi %}
                    {{ employee.bmi }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">BMI Category</td>
                <td class="border px-4 py-2">{{ employee.bmi_category|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Kontak Darurat</td>
                <td class="border px-4 py-2">
                  {% if not view_only %}
                  <form method="post" action="{% url 'nurse:karyawan_detail' employee.uid %}?submenu=edit" class="flex items-center gap-2">
                    {% csrf_token %}
                    <input type="text" name="kontak_darurat" value="{{ employee.kontak_darurat|default:'' }}" placeholder="Masukkan kontak darurat" class="border px-2 py-1 rounded w-full"/>
                    <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Simpan</button>
                  </form>
                  {% else %}
                    {{ employee.kontak_darurat|default:"-" }}
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- MCU DataFrame -->
        <div class="mt-6 p-4 bg-white shadow rounded">
          <h3 class="text-lg font-semibold mb-3">MCU</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse border border-gray-300">
              <thead>
                <tr class="bg-gray-100">
                  <th class="border px-4 py-2 text-left">Field</th>
                  <th class="border px-4 py-2 text-left">Value</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="border px-4 py-2">Tanggal MCU</td>
                  <td class="border px-4 py-2">{{ employee.tanggal_MCU|default:"-" }}</td>
                </tr>
                <tr>
                  <td class="border px-4 py-2">Expired MCU</td>
                  <td class="border px-4 py-2">{{ employee.expired_MCU|default:"-" }}</td>
                </tr>
                <tr>
                  <td class="border px-4 py-2">Estimasi Hari ke Expired</td>
                  <td class="border px-4 py-2">{{ mcu_expiry_estimate|default:"-" }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 3. Latest Medical Checkup (DataFrame-style) -->
      <section class="mt-6 p-4 bg-white shadow rounded">
        <h3 class="text-lg font-semibold mb-3">Data Checkup Terakhir</h3>
        {% if latest_checkup %}
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2 text-left">Field</th>
                <th class="border px-4 py-2 text-left">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-4 py-2">Tanggal Checkup</td>
                <td class="border px-4 py-2">{{ latest_checkup.tanggal_checkup }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Puasa</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.gdp_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.gula_darah_puasa|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Sewaktu</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.gds_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.gula_darah_sewaktu|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Cholesterol</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.chol_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.cholesterol|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Asam Urat</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.asam_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.asam_urat|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Derajat Kesehatan</td>
                <td class="border px-4 py-2">
                  {% with dk=latest_checkup.derajat_kesehatan|default:""|upper %}
                    {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                      <span class="text-green-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P4" %}
                      <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P5" %}
                      <span class="text-orange-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P6" or dk == "P7" %}
                      <span class="text-red-600 font-semibold">{{ dk }}</span>
                    {% elif dk %}
                      <span class="text-gray-700 font-semibold">{{ dk }}</span>
                    {% else %}
                      <span class="text-gray-400 italic">-</span>
                    {% endif %}
                  {% endwith %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Lingkar Perut (cm)</td>
                <td class="border px-4 py-2">{{ latest_checkup.lingkar_perut|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Status</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.status %}
                    <span class="inline-block px-2 py-1 rounded text-white {% if latest_checkup.status == 'Unwell' %}bg-red-500{% else %}bg-green-500{% endif %}">{{ latest_checkup.status }}</span>
                  {% else %}
                    <span class="text-gray-500">-</span>
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-4 bg-gray-50 border rounded text-gray-500">Belum ada data medical checkup.</div>
        {% endif %}
      </section>
  </div>

  <!-- Edit Karyawan Data Content (empty; now under Data Karyawan > Edit Karyawan Data) -->
  <div id="edit-data-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'data_karyawan' or active_subtab != 'edit_data' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Edit Data Checkup</h2>
      <div class="mb-2">
         <span class="text-sm text-green-600 font-semibold cursor-help" title="Pilih karyawan di tab Karyawan Profile">Pilih karyawan di tab Karyawan Profile</span>
      </div>
      <!-- Removed duplicate Karyawan name label as it's already shown in the container/header -->
      {% include 'nurse/partials/edit_karyawan_form.html' with karyawan=employee %}
  </div>

  <!-- History Medical Check Up Content -->
  <div id="history-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'history' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">History Medical Check Up</h2>
      {% if history_dashboard and history_dashboard|length > 0 %}
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Lahir</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umur</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Checkup</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lingkar Perut</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GDP</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GDS</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cholesterol</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asam Urat</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tekanan Darah</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derajat Kesehatan</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal MCU</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expired MCU</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for row in history_dashboard %}
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ forloop.counter }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.uid }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.nama|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.jabatan|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.lokasi|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tanggal_lahir|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.umur|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tanggal_checkup|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.lingkar_perut|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.gula_darah_puasa|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.gula_darah_sewaktu|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.cholesterol|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.asam_urat|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tekanan_darah|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% with dk=row.derajat_kesehatan|default:""|upper %}
                  {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                    <span class="text-green-600 font-semibold">{{ dk }}</span>
                  {% elif dk == "P4" %}
                    <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                  {% elif dk == "P5" %}
                    <span class="text-orange-600 font-semibold">{{ dk }}</span>
                  {% elif dk == "P6" or dk == "P7" %}
                    <span class="text-red-600 font-semibold">{{ dk }}</span>
                  {% elif dk %}
                    <span class="text-gray-700 font-semibold">{{ dk }}</span>
                  {% else %}
                    <span class="text-gray-400 italic">-</span>
                  {% endif %}
                {% endwith %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tanggal_MCU|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.expired_MCU|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if row.status == "Unwell" %}
                  <span class="text-red-600 font-semibold">Unwell</span>
                {% elif row.status == "Well" %}
                  <span class="text-green-600 font-semibold">Well</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="p-4 bg-gray-50 border rounded text-gray-500">
          Belum ada data medical checkup.
        </div>
      {% endif %}
  </div>
</div>
{% endblock %}

{% extends "nurse/nurse_index.html" %}
{% load static %}

{% block page_content %}
<div class="bg-white rounded-lg shadow_md p-6">
    <!-- Submenu Navigation -->
    <div class="flex gap-6 mb-6 px-3 pt-3 border-b border-slate-300 bg-white rounded-t-xl shadow-sm">
        <a href="?submenu=data" 
           class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                  {% if active_submenu == 'data' %}bg-blue-600 text-white border-blue-600{% endif %}">
            DATA KARYAWAN
        </a>
        <a href="?submenu=grafik" 
           class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                  {% if active_submenu == 'grafik' %}bg-blue-600 text-white border-blue-600{% endif %}">
            GRAFIK
        </a>
    </div>

    <!-- Data Karyawan Content -->
    <div id="data-content" class="{% if active_submenu != 'data' %}hidden{% endif %}">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-100 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-800">Total Karyawan</h3>
                <p class="text-2xl font-bold text-blue-900">{{ total_karyawan }}</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-green-800">Well</h3>
                <p class="text-2xl font-bold text-green-900">{{ total_well }}</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-red-800">Unwell</h3>
                <p class="text-2xl font-bold text-red-900">{{ total_unwell }}</p>
            </div>
        </div>

        <!-- Filter Form -->
        <form method="get" class="mb-6 bg-gray-50 p-4 rounded-lg">
            <input type="hidden" name="submenu" value="{{ active_submenu }}">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="nama_filter" class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                    <input type="text" id="nama_filter" name="nama" value="{{ filters.nama }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Cari berdasarkan nama...">
                </div>
                <div>
                    <label for="jabatan_filter" class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                    <select id="jabatan_filter" name="jabatan"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Semua Jabatan</option>
                        {% for jabatan in available_jabatan %}
                        <option value="{{ jabatan }}" {% if filters.jabatan == jabatan %}selected{% endif %}>
                            {{ jabatan }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="lokasi_filter" class="block text-sm font-medium text-gray-700 mb-1">Lokasi</label>
                    <select id="lokasi_filter" name="lokasi"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Semua Lokasi</option>
                        {% for lokasi in available_lokasi %}
                        <option value="{{ lokasi }}" {% if filters.lokasi == lokasi %}selected{% endif %}>
                            {{ lokasi }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="status_filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status_filter" name="status"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Semua Status</option>
                        {% for status in available_status %}
                        <option value="{{ status }}" {% if filters.status == status %}selected{% endif %}>
                            {{ status }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="expiry_filter" class="block text-sm font-medium text-gray-700 mb-1">MCU Expiry</label>
                    <select id="expiry_filter" name="expiry"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Semua</option>
                        <option value="expired" {% if filters.expiry == 'expired' %}selected{% endif %}>Expired</option>
                        <option value="warning" {% if filters.expiry == 'warning' %}selected{% endif %}>Almost Expired (â‰¤60 hari)</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Filter
                </button>
                {% if filters.nama or filters.jabatan or filters.lokasi or filters.status or filters.expiry %}
                <a href="?submenu={{ active_submenu }}" class="ml-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                    Reset
                </a>
                {% endif %}
            </div>
        </form>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Lahir</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umur</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Checkup</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tinggi</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Berat</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BMI</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BMI Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lingkar Perut</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gula Darah Puasa</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gula Darah Sewaktu</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cholesterol</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asam Urat</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tekanan Darah</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derajat Kesehatan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal MCU</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expired MCU</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for employee in employees %}
                    <tr class="dashboard-row hover:bg-gray-50 cursor-pointer" data-url="{% url 'nurse:karyawan_detail' employee.uid %}?submenu=data_karyawan&subtab=profile" title="Klik baris untuk membuka profil">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ forloop.counter|add:start_index }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.uid }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.nama }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.jabatan }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.lokasi }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.tanggal_lahir|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.umur|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.tanggal_checkup|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.tinggi|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.berat|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.bmi|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.bmi_category|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.lingkar_perut|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.gula_darah_puasa|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.gula_darah_sewaktu|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.cholesterol|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.asam_urat|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ employee.tekanan_darah|default:"-" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% with dk=employee.derajat_kesehatan|default:""|upper %}
                                {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                                    <span class="text-green-600 font-semibold">{{ dk }}</span>
                                {% elif dk == "P4" %}
                                    <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                                {% elif dk == "P5" %}
                                    <span class="text-orange-600 font-semibold">{{ dk }}</span>
                                {% elif dk == "P6" or dk == "P7" %}
                                    <span class="text-red-600 font-semibold">{{ dk }}</span>
                                {% elif dk %}
                                    <span class="text-gray-700 font-semibold">{{ dk }}</span>
                                {% else %}
                                    <span class="text-gray-400 italic">-</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if employee.mcu_is_expired %}
                                <span class="text-red-600 font-semibold">{{ employee.tanggal_MCU|default:"-" }}</span>
                            {% elif employee.mcu_is_warning %}
                                <span class="text-yellow-600 font-semibold">{{ employee.tanggal_MCU|default:"-" }}</span>
                            {% else %}
                                {{ employee.tanggal_MCU|default:"-" }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if employee.mcu_is_expired %}
                                <span class="text-red-600 font-semibold">{{ employee.expired_MCU|default:"-" }}</span>
                            {% elif employee.mcu_is_warning %}
                                <span class="text-yellow-600 font-semibold">{{ employee.expired_MCU|default:"-" }}</span>
                            {% else %}
                                {{ employee.expired_MCU|default:"-" }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if employee.status == "Unwell" %}
                                <span class="text-red-600 font-semibold">Unwell</span>
                            {% elif employee.status == "Well" %}
                                <span class="text-green-600 font-semibold">Well</span>
                            {% else %}
                                <span class="text-gray-400 italic">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls (fixed & centered) -->
        {% if total_pages > 1 %}
        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 transform z-40 flex justify-center items-center gap-2 bg-white/90 backdrop-blur-sm rounded-full shadow-md px-4 py-2 border border-gray-200">
            {% if current_page > 1 %}
            <a href="?submenu={{ active_submenu }}&page={{ current_page|add:'-1' }}{% if current_filters.nama %}&nama={{ current_filters.nama }}{% endif %}{% if current_filters.jabatan %}&jabatan={{ current_filters.jabatan }}{% endif %}{% if current_filters.lokasi %}&lokasi={{ current_filters.lokasi }}{% endif %}{% if current_filters.status %}&status={{ current_filters.status }}{% endif %}{% if current_filters.expiry %}&expiry={{ current_filters.expiry }}{% endif %}"
               class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                Sebelumnya
            </a>
            {% endif %}

            <span class="px-3 py-1 text-gray-700">
                Page {{ current_page }} of {{ total_pages }}
            </span>

            {% if current_page < total_pages %}
            <a href="?submenu={{ active_submenu }}&page={{ current_page|add:'1' }}{% if current_filters.nama %}&nama={{ current_filters.nama }}{% endif %}{% if current_filters.jabatan %}&jabatan={{ current_filters.jabatan }}{% endif %}{% if current_filters.lokasi %}&lokasi={{ current_filters.lokasi }}{% endif %}{% if current_filters.status %}&status={{ current_filters.status }}{% endif %}{% if current_filters.expiry %}&expiry={{ current_filters.expiry }}{% endif %}"
               class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                Berikutnya
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Grafik Content -->
    <div id="grafik-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'grafik' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Grafik</h2>
      <form id="grafik-filter-form" class="mb-4 flex items-center gap-2 flex-wrap">
        <label class="font-medium">Range Bulan:</label>
        <input type="month" id="start_month" name="start_month" value="{{ default_start_month }}" class="border px-2 py-1 rounded">
        <span class="mx-1">s/d</span>
        <input type="month" id="end_month" name="end_month" value="{{ default_end_month }}" class="border px-2 py-1 rounded">
        <label class="font-medium ml-4">Karyawan:</label>
        <select id="uid_select" name="uid" class="border px-2 py-1 rounded">
          <option value="all">Semua Karyawan</option>
          {% for employee in available_employees %}
          <option value="{{ employee.uid }}">{{ employee.nama }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Terapkan</button>
      </form>

      <div id="parameter-selector" class="mb-4 flex items-center gap-2 flex-wrap">
        <label class="font-medium">Parameter:</label>
        <!-- Colorful chips with double-click isolate behavior -->
        <button type="button" class="param-chip selected px-2 py-1 rounded text-white" data-key="gula_darah_puasa" data-color="#3367d6" style="background-color:#3367d6">Gula Darah Puasa</button>
        <button type="button" class="param-chip selected px-2 py-1 rounded text-white" data-key="gula_darah_sewaktu" data-color="#7baaf7" style="background-color:#7baaf7">Gula Darah Sewaktu</button>
        <button type="button" class="param-chip selected px-2 py-1 rounded text-white" data-key="tekanan_darah_sistole" data-color="#ef6c00" style="background-color:#ef6c00">Tekanan Darah (Sistole)</button>
        <button type="button" class="param-chip selected px-2 py-1 rounded text-white" data-key="lingkar_perut" data-color="#8e24aa" style="background-color:#8e24aa">Lingkar Perut</button>
        <button type="button" class="param-chip selected px-2 py-1 rounded text-white" data-key="cholesterol" data-color="#2e7d32" style="background-color:#2e7d32">Cholesterol</button>
        <button type="button" class="param-chip selected px-2 py-1 rounded text-white" data-key="asam_urat" data-color="#c62828" style="background-color:#c62828">Asam Urat</button>
      </div>

      <div id="grafik-chart" class="w-full overflow-x-auto min-h-[300px] mb-4">
        <div class="p-4 bg-gray-50 border rounded text-gray-500" id="grafik-placeholder">
          Pilih range bulan dan karyawan, lalu klik "Terapkan" untuk menampilkan grafik.
        </div>
      </div>

      <!-- Summary cards removed per new requirements -->
    </div>


<!-- Plotly CDN for charts -->
<script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Row click navigation to employee profile
    const rows = document.querySelectorAll('tr.dashboard-row[data-url]');
    rows.forEach(row => {
      row.addEventListener('click', function(e) {
        const isInteractive = e.target.closest('a, button, input, select, textarea');
        if (isInteractive) return;
        const url = row.getAttribute('data-url');
        if (url) {
          window.location.href = url;
        }
      });
    });

    // Grafik: dynamic fetch + render
    const chartEl = document.getElementById('grafik-chart');

    function getSelectedParams() {
      const chips = document.querySelectorAll('.param-chip');
      const keys = [];
      chips.forEach(chip => { if (chip.classList.contains('selected')) keys.push(chip.getAttribute('data-key')); });
      return keys;
    }

    function renderIndividual(data, selectedKeys) {
      const x = data.x_dates || [];
      const s = data.series || {};
      const traces = [];
      const seriesMeta = [
        { key: 'gula_darah_puasa', name: 'Gula Darah Puasa', color: '#3367d6' },
        { key: 'gula_darah_sewaktu', name: 'Gula Darah Sewaktu', color: '#7baaf7' },
        { key: 'tekanan_darah_sistole', name: 'Tekanan Darah (Sistole)', color: '#ef6c00' },
        { key: 'lingkar_perut', name: 'Lingkar Perut', color: '#8e24aa' },
        { key: 'cholesterol', name: 'Cholesterol', color: '#2e7d32' },
        { key: 'asam_urat', name: 'Asam Urat', color: '#c62828' },
      ];
      const selected = selectedKeys && selectedKeys.length ? selectedKeys : seriesMeta.map(m => m.key);
      seriesMeta.forEach(meta => {
        if (!selected.includes(meta.key)) return;
        traces.push({
          x: x,
          y: (s[meta.key] || []).map(v => v === null ? null : Number(v)),
          mode: 'lines+markers',
          name: meta.name,
          line: { color: meta.color },
          connectgaps: false,
        });
      });
      const layout = {
        title: 'Grafik',
        xaxis: { title: 'Tanggal MCU', type: 'category' },
        yaxis: { title: 'Nilai Parameter' },
        legend: { orientation: 'h', yanchor: 'bottom', y: 1.02, xanchor: 'right', x: 1 },
        margin: { l: 40, r: 20, t: 60, b: 40 },
        template: 'plotly_white'
      };
      Plotly.newPlot(chartEl, traces, layout, { responsive: true });
    }

    function renderMultiLine(data, selectedKeys) {
      const x = data.x_dates || [];
      const seriesByEmployee = data.series_by_employee || {};
      const traces = [];
      const activeParam = (selectedKeys && selectedKeys.length) ? selectedKeys[0] : 'gula_darah_puasa';
      Object.keys(seriesByEmployee).forEach(uid => {
        const emp = seriesByEmployee[uid] || {};
        const y = (emp[activeParam] || []).map(v => v === null ? null : Number(v));
        const name = emp.nama || uid;
        traces.push({
          x: x,
          y: y,
          mode: 'lines+markers',
          name: name,
          connectgaps: false,
        });
      });
      const layout = {
        title: 'Grafik',
        xaxis: { title: 'Tanggal MCU', type: 'category' },
        yaxis: { title: 'Nilai Parameter' },
        legend: { orientation: 'h', yanchor: 'bottom', y: 1.02, xanchor: 'right', x: 1 },
        margin: { l: 40, r: 20, t: 60, b: 40 },
        template: 'plotly_white'
      };
      Plotly.newPlot(chartEl, traces, layout, { responsive: true });
    }

    async function fetchGrafik(params) {
      const url = new URL(window.location.pathname, window.location.origin);
      url.searchParams.set('submenu', 'grafik');
      url.searchParams.set('grafik_json', '1');
      Object.entries(params || {}).forEach(([k, v]) => {
        if (v != null && v !== '') url.searchParams.set(k, v);
      });
      const placeholder = document.getElementById('grafik-placeholder');
      if (placeholder) {
        placeholder.innerHTML = '<div class="text-gray-600">Memuat data grafik...</div>';
      }
      try {
        const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await resp.json();
        if (placeholder) { placeholder.style.display = 'none'; }
        const selected = getSelectedParams();
        if (data.mode === 'individual') {
          renderIndividual(data, selected);
        } else if (data.mode === 'multiline') {
          renderMultiLine(data, selected);
        }
        window._grafik_last = { mode: data.mode, data };
      } catch (e) {
        if (placeholder) {
          placeholder.innerHTML = '<div class="text-red-600">Gagal memuat data grafik.</div>';
          placeholder.style.display = 'block';
        }
      }
    }

    const filterForm = document.getElementById('grafik-filter-form');
    if (filterForm) {
      filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const uid = document.getElementById('uid_select').value;
        const startMonth = document.getElementById('start_month').value;
        const endMonth = document.getElementById('end_month').value;
        fetchGrafik({ uid: uid, start_month: startMonth, end_month: endMonth });
      });
    }

    const paramSelector = document.getElementById('parameter-selector');
    if (paramSelector) {
      // Visual helper
      const applyChipVisual = (chip) => {
        const color = chip.getAttribute('data-color') || '#888';
        if (chip.classList.contains('selected')) {
          chip.style.backgroundColor = color;
          chip.classList.remove('opacity-60');
        } else {
          chip.style.backgroundColor = color;
          chip.classList.add('opacity-60');
        }
      };
      // Initialize visuals
      paramSelector.querySelectorAll('.param-chip').forEach(applyChipVisual);

      const rerender = () => {
        const last = window._grafik_last;
        const selected = getSelectedParams();
        if (last && last.mode === 'individual') {
          renderIndividual(last.data, selected);
        } else if (last && last.mode === 'multiline') {
          // Ensure only one active parameter for multiline view
          const one = selected.length ? [selected[0]] : ['gula_darah_puasa'];
          renderMultiLine(last.data, one);
        }
      };

      // Click: toggle (individual allows multi; multiline enforces single)
      paramSelector.addEventListener('click', function(e) {
        const chip = e.target.closest('.param-chip');
        if (!chip) return;
        const last = window._grafik_last;
        if (last && last.mode === 'multiline') {
          // Single selection only
          paramSelector.querySelectorAll('.param-chip').forEach(c => {
            c.classList.remove('selected');
            applyChipVisual(c);
          });
          chip.classList.add('selected');
          applyChipVisual(chip);
        } else {
          // Toggle selection
          chip.classList.toggle('selected');
          // Prevent unselecting all; keep at least one selected
          const anySelected = getSelectedParams().length > 0;
          if (!anySelected) chip.classList.add('selected');
          applyChipVisual(chip);
        }
        rerender();
      });

      // Double-click: isolate this parameter (select only this)
      paramSelector.addEventListener('dblclick', function(e) {
        const chip = e.target.closest('.param-chip');
        if (!chip) return;
        paramSelector.querySelectorAll('.param-chip').forEach(c => {
          c.classList.remove('selected');
          applyChipVisual(c);
        });
        chip.classList.add('selected');
        applyChipVisual(chip);
        rerender();
      });
    }

    // No initial auto-load - user must click "Terapkan" to see chart
  });
</script>
{% endblock %}

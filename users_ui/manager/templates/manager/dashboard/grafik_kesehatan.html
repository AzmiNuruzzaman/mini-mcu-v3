{% load static %}

<!-- Dashboard: Grafik Kesehatan (anchored to stable grafik section) -->
<div id="grafik-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if grafik_subtab != 'grafik_kesehatan' %}hidden{% endif %}">
  <h2 class="text-xl font-bold mb-3">Grafik Riwayat Medical Check Up</h2>
  <form method="get" class="mb-4 flex items-center gap-2">
    <input type="hidden" name="submenu" value="grafik"/>
    {% if request.GET.uid %}
    <input type="hidden" name="uid" value="{{ request.GET.uid }}"/>
    {% endif %}
    <label class="font-medium">Range Bulan:</label>
    <input type="month" name="start_month" value="{{ grafik_start_month }}" class="border px-2 py-1 rounded">
    <span class="mx-1">s/d</span>
    <input type="month" name="end_month" value="{{ grafik_end_month }}" class="border px-2 py-1 rounded">
    <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Terapkan</button>
  </form>

  {% if grafik_chart_html %}
    <div class="w-full overflow-x-auto">
      {{ grafik_chart_html|safe }}
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        var grafContainer = document.querySelector('#grafik-content .plotly-graph-div');
        if (!grafContainer || typeof Plotly === 'undefined' || !Plotly.relayout) return;

        const thresholdValues = {
          'Gula Darah Puasa': 126,
          'Gula Darah Sewaktu': 200,
          'Asam Urat': 7,
          'Cholesterol': 200,
          'BMI': 30
        };

        // Legend click → draw threshold line (if exists) and keep ticks visible
        grafContainer.on('plotly_legendclick', function(ev){
          try {
            var idx = ev.curveNumber;
            var d = ev.data || (ev.fullData || []);
            var name = (d && d[idx] && d[idx].name) ? d[idx].name : null;
            if (!name) return true;
            var thr = thresholdValues[name];
            var shapes = [];
            if (thr != null) {
              shapes = [{ type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: thr, y1: thr, line: { color: 'rgba(255,0,0,0.35)', width: 2, dash: 'dash' } }];
            }
            Plotly.relayout(grafContainer, { shapes: shapes, 'yaxis.showticklabels': true });
            try { Plotly.redraw(grafContainer); } catch(e) {}
            try { Plotly.Plots.resize(grafContainer); } catch(e) {}
          } catch(e) {}
          return true;
        });

        // Bar/point click → draw threshold line
        grafContainer.on('plotly_click', function(ev){
          try {
            var pt = ev.points && ev.points[0];
            var name = pt && pt.data && pt.data.name;
            var thr = thresholdValues[name];
            if (thr == null) return;
            var shape = { type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: thr, y1: thr, line: { color: 'rgba(255,0,0,0.35)', width: 2, dash: 'dash' } };
            Plotly.relayout(grafContainer, { shapes: [shape], 'yaxis.showticklabels': true });
            try { Plotly.redraw(grafContainer); } catch(e) {}
            try { Plotly.Plots.resize(grafContainer); } catch(e) {}
          } catch(e) {}
        });

        // Keep chart responsive
        window.addEventListener('resize', function(){
          try { Plotly.Plots.resize(grafContainer); } catch(e) {}
        });
      });
    </script>
  {% else %}
    <div class="p-4 bg-gray-50 border rounded text-gray-500">Belum ada data grafik untuk range ini.</div>
  {% endif %}
</div>
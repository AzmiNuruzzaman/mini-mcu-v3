{% extends "manager/manager_index.html" %}
{% load static %}

{% block title %}{% if view_only %}karyawan{% else %}Manager Dashboard - {{ active_menu_label }}{% endif %}{% endblock %}

{% block page_content %}
<div class="bg-white rounded-lg shadow-md p-6">
  <!-- Feedback Messages -->
  {% if success_message %}
    <div class="mb-4 p-3 rounded bg-green-100 text-green-800 border border-green-300">{{ success_message }}</div>
  {% endif %}
  {% if error_message %}
    <div class="mb-4 p-3 rounded bg-red-100 text-red-800 border border-red-300">{{ error_message }}</div>
  {% endif %}

  <!-- Submenu Navigation -->
  <div class="flex gap-6 mb-4 px-3 pt-3 border-b border-slate-300 bg-white rounded-t-xl shadow-sm">
      <a href="?submenu=edit" 
         class="hidden pb-3 px-4 font-medium text-gray-700 hover:text-blue-600 transition-colors
                {% if active_submenu == 'edit' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
          Karyawan Profile
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=data_karyawan{% else %}?submenu=data_karyawan{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'data_karyawan' %}bg-blue-600 text-white border-blue-600{% endif %}">
          Data Karyawan
      </a>
      <a href="?submenu=edit_data" 
         class="hidden pb-3 px-4 font-medium text-gray-700 hover:text-blue-600 transition-colors
                {% if active_submenu == 'edit_data' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
          Edit Master Data
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=history{% else %}?submenu=history{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'history' %}bg-blue-600 text-white border-blue-600{% endif %}">
          History Medical Check Up
      </a>
      <a href="{% if view_only %}?uid={{ employee.uid }}&submenu=grafik{% else %}?submenu=grafik{% endif %}" 
         class="pb-3 px-4 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300
                {% if active_submenu == 'grafik' %}bg-blue-600 text-white border-blue-600{% endif %}">
          Grafik
      </a>
  </div>

  {% if active_submenu == 'data_karyawan' %}
  <!-- Inner tabs under Data Karyawan -->
  <div class="flex gap-2 mb-4 px-3 pt-3 border-b border-slate-300 bg-white rounded-t-md shadow-sm overflow-x-auto whitespace-nowrap">
      <a href="?submenu=data_karyawan&subtab=profile" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'profile' %}bg-green-600 text-white border-green-600{% endif %}">
          Karyawan Profile
      </a>
      {% if not view_only %}
      <a href="?submenu=data_karyawan&subtab=edit_data" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'edit_data' %}bg-green-600 text-white border-green-600{% endif %}">
          Edit Master Data
      </a>
      <a href="?submenu=data_karyawan&subtab=lokasi" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'lokasi' %}bg-green-600 text-white border-green-600{% endif %}">
          Lokasi Management
      </a>
      <a href="?submenu=data_karyawan&subtab=edit_checkup" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'edit_checkup' %}bg-green-600 text-white border-green-600{% endif %}">
          Edit Data Checkup
      </a>
      <a href="?submenu=data_karyawan&subtab=tambah" 
         class="pb-2 px-3 font-medium text-gray-700 hover:bg-slate-100 rounded-t-md border border-slate-300 -mb-px transition-colors focus:outline-none focus:ring-2 focus:ring-green-300
                {% if active_subtab == 'tambah' %}bg-green-600 text-white border-green-600{% endif %}">
          Tambah karyawan
      </a>
      {% endif %}
  </div>
  {% endif %}

  <!-- Edit Data Karyawan Content (now shown under Data Karyawan > Karyawan Profile) -->
  <div id="edit-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'data_karyawan' or active_subtab != 'profile' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Edit Karyawan</h2>

      <!-- 1. Selector box by nama on the top -->
      {% if not view_only %}
      <form method="get" class="mb-4">
        <input type="hidden" name="submenu" value="edit"/>
        <label for="uid" class="block mb-2 font-medium">Pilih Karyawan (Nama):</label>
        <select name="uid" id="uid" class="select2 border px-2 py-1 rounded w-full" onchange="this.form.submit()">
          {% for e in employees %}
            <option value="{{ e.uid }}" {% if employee.uid == e.uid %}selected{% endif %}>{{ e.nama }}</option>
          {% endfor %}
        </select>
      </form>
      {% endif %}

      <!-- 2. Dataframe style display karyawan info with editable kontak darurat -->
      <section class="p-4 bg-white shadow rounded">
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2 text-left">Field</th>
                <th class="border px-4 py-2 text-left">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-4 py-2">Nama</td>
                <td class="border px-4 py-2">{{ employee.nama }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">UID</td>
                <td class="border px-4 py-2"><span class="font-mono">{{ employee.uid }}</span></td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Jabatan</td>
                <td class="border px-4 py-2">{{ employee.jabatan }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Lokasi</td>
                <td class="border px-4 py-2">{{ employee.lokasi }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Tanggal Lahir</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.tanggal_lahir %}
                    {{ latest_checkup.tanggal_lahir }}
                  {% elif employee.tanggal_lahir %}
                    {{ employee.tanggal_lahir }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="hidden">
                <td class="border px-4 py-2">Umur</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.umur %}
                    {{ latest_checkup.umur }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Derajat Kesehatan</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.derajat_kesehatan %}
                    {% with dk=latest_checkup.derajat_kesehatan|upper %}
                      {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                        <span class="text-green-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P4" %}
                        <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P5" %}
                        <span class="text-orange-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P6" or dk == "P7" %}
                        <span class="text-red-600 font-semibold">{{ dk }}</span>
                      {% elif dk %}
                        <span class="text-gray-700 font-semibold">{{ dk }}</span>
                      {% else %}
                        <span class="text-gray-400 italic">-</span>
                      {% endif %}
                    {% endwith %}
                  {% elif employee.derajat_kesehatan %}
                    {% with dk=employee.derajat_kesehatan|upper %}
                      {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                        <span class="text-green-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P4" %}
                        <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P5" %}
                        <span class="text-orange-600 font-semibold">{{ dk }}</span>
                      {% elif dk == "P6" or dk == "P7" %}
                        <span class="text-red-600 font-semibold">{{ dk }}</span>
                      {% elif dk %}
                        <span class="text-gray-700 font-semibold">{{ dk }}</span>
                      {% else %}
                        <span class="text-gray-400 italic">-</span>
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    <span class="text-gray-400 italic">-</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Berat</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.berat %}
                    {{ latest_checkup.berat }}
                  {% elif employee.berat %}
                    {{ employee.berat }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Tinggi</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.tinggi %}
                    {{ latest_checkup.tinggi }}
                  {% elif employee.tinggi %}
                    {{ employee.tinggi }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">BMI</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.bmi %}
                    {{ latest_checkup.bmi }}
                  {% elif employee.bmi %}
                    {{ employee.bmi }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="border px-4 py-2">BMI Category</td>
                <td class="border px-4 py-2">{{ employee.bmi_category|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Kontak Darurat</td>
                <td class="border px-4 py-2">
                  {% if not view_only %}
                  <form method="post" action="{% url 'manager:edit_karyawan' employee.uid %}?submenu=edit" class="flex items-center gap-2">
                    {% csrf_token %}
                    <input type="text" name="kontak_darurat" value="{{ employee.kontak_darurat|default:'' }}" placeholder="Masukkan kontak darurat" class="border px-2 py-1 rounded w-full"/>
                    <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Simpan</button>
                  </form>
                  {% else %}
                    {{ employee.kontak_darurat|default:"-" }}
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- MCU DataFrame -->
        <div class="mt-6 p-4 bg-white shadow rounded">
          <h3 class="text-lg font-semibold mb-3">MCU</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse border border-gray-300">
              <thead>
                <tr class="bg-gray-100">
                  <th class="border px-4 py-2 text-left">Field</th>
                  <th class="border px-4 py-2 text-left">Value</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="border px-4 py-2">Tanggal MCU</td>
                  <td class="border px-4 py-2">{{ employee.tanggal_MCU|default:"-" }}</td>
                </tr>
                <tr>
                  <td class="border px-4 py-2">Expired MCU</td>
                  <td class="border px-4 py-2">{{ employee.expired_MCU|default:"-" }}</td>
                </tr>
                <tr>
                  <td class="border px-4 py-2">Estimasi Hari ke Expired</td>
                  <td class="border px-4 py-2">{{ mcu_expiry_estimate|default:"-" }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 3. Latest Medical Checkup (DataFrame-style) -->
      <section class="mt-6 p-4 bg-white shadow rounded">
        <h3 class="text-lg font-semibold mb-3">Data Checkup Terakhir</h3>
        {% if latest_checkup %}
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2 text-left">Field</th>
                <th class="border px-4 py-2 text-left">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border px-4 py-2">Tanggal Checkup</td>
                <td class="border px-4 py-2">{{ latest_checkup.tanggal_checkup }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Puasa</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.gdp_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.gula_darah_puasa|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Sewaktu</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.gds_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.gula_darah_sewaktu|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Cholesterol</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.chol_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.cholesterol|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Asam Urat</td>
                <td class="border px-4 py-2 {% if latest_checkup.flags and latest_checkup.flags.asam_high %}text-red-600 font-semibold{% endif %}">{{ latest_checkup.asam_urat|default:"-" }}</td>
              </tr>
              {% if not view_only %}
              <tr>
                <td class="border px-4 py-2">Derajat Kesehatan</td>
                <td class="border px-4 py-2">
                  {% with dk=latest_checkup.derajat_kesehatan|default:""|upper %}
                    {% if dk == "P1" or dk == "P2" or dk == "P3" %}
                      <span class="text-green-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P4" %}
                      <span class="text-yellow-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P5" %}
                      <span class="text-orange-600 font-semibold">{{ dk }}</span>
                    {% elif dk == "P6" or dk == "P7" %}
                      <span class="text-red-600 font-semibold">{{ dk }}</span>
                    {% elif dk %}
                      <span class="text-gray-700 font-semibold">{{ dk }}</span>
                    {% else %}
                      <span class="text-gray-400 italic">-</span>
                    {% endif %}
                  {% endwith %}
                </td>
              </tr>
              {% endif %}
              <tr>
                <td class="border px-4 py-2">Lingkar Perut (cm)</td>
                <td class="border px-4 py-2">{{ latest_checkup.lingkar_perut|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Puasa</td>
                <td class="border px-4 py-2">{{ latest_checkup.gula_darah_puasa|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Gula Darah Sewaktu</td>
                <td class="border px-4 py-2">{{ latest_checkup.gula_darah_sewaktu|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Cholesterol</td>
                <td class="border px-4 py-2">{{ latest_checkup.cholesterol|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Asam Urat</td>
                <td class="border px-4 py-2">{{ latest_checkup.asam_urat|default:"-" }}</td>
              </tr>
              <tr>
                <td class="border px-4 py-2">Status</td>
                <td class="border px-4 py-2">
                  {% if latest_checkup and latest_checkup.status %}
                    <span class="inline-block px-2 py-1 rounded text-white {% if latest_checkup.status == 'Unwell' %}bg-red-500{% else %}bg-green-500{% endif %}">{{ latest_checkup.status }}</span>
                  {% else %}
                    <span class="text-gray-500">-</span>
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-4 bg-gray-50 border rounded text-gray-500">Belum ada data medical checkup.</div>
        {% endif %}
      </section>
  </div>

  <!-- Edit Master Data Content (empty; now under Data Karyawan > Edit Master Data) -->
  {% if not view_only %}
  <div id="edit-data-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'data_karyawan' or active_subtab != 'edit_data' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Edit Master Data</h2>
      <div class="mb-2">
          <span class="text-sm text-green-600 font-semibold cursor-help" title="Pilih karyawan di tab Karyawan Profile">Pilih karyawan di tab Karyawan Profile</span>
      </div>
      {% include 'manager/partials/edit_karyawan_form.html' with karyawan=employee %}
  </div>
  {% endif %}

  {% if not view_only %}
  <div id="lokasi-management-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'data_karyawan' or active_subtab != 'lokasi' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Lokasi Management</h2>
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">Daftar Lokasi Saat Ini</h3>
        {% if lokasi_list and lokasi_list|length > 0 %}
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2 text-left">No</th>
                <th class="border px-4 py-2 text-left">Nama Lokasi</th>
              </tr>
            </thead>
            <tbody>
              {% for nama in lokasi_list %}
              <tr>
                <td class="border px-4 py-2">{{ forloop.counter }}</td>
                <td class="border px-4 py-2">{{ nama }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-4 bg-gray-50 border rounded text-gray-500">Belum ada lokasi.</div>
        {% endif %}
      </div>
      <div class="mt-2">
        <h3 class="text-lg font-semibold mb-2">Tambah Lokasi Baru</h3>
        <form method="post" action="{% url 'manager:add_lokasi' %}" class="flex items-center gap-2">
          {% csrf_token %}
          <input type="hidden" name="current_uid" value="{{ employee.uid }}">
          <input type="text" name="lokasi" class="border px-2 py-1 rounded w-full" placeholder="Masukkan nama lokasi baru" required>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Tambah Lokasi</button>
        </form>
        <p class="mt-2 text-xs text-gray-500">Catatan: lokasi baru akan tersedia di pilihan Lokasi pada form Edit Master Data dan Tambah karyawan.</p>
      </div>
  </div>
  {% endif %}

  {% if not view_only %}
  <div id="edit-checkup-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'data_karyawan' or active_subtab != 'edit_checkup' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Edit Data Checkup</h2>
      <div class="mb-3">
        <div class="text-sm text-gray-700">Nama: <span class="font-semibold">{{ employee.nama }}</span></div>
        <div class="text-sm text-gray-700">UID: <span class="font-mono">{{ employee.uid }}</span></div>
      </div>
      <form method="post" action="{% url 'manager:save_medical_checkup' employee.uid %}?submenu=data_karyawan&subtab=edit_checkup" class="space-y-4">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold mb-1">Tanggal Checkup</label>
            <input type="date" name="tanggal_checkup" class="w-full border px-2 py-1 rounded">
          </div>
          <div>
            <label class="block font-semibold mb-1">Gula Darah Puasa</label>
            <input type="number" step="any" name="gula_darah_puasa" class="w-full border px-2 py-1 rounded" placeholder="mg/dL">
          </div>
          <div>
            <label class="block font-semibold mb-1">Gula Darah Sewaktu</label>
            <input type="number" step="any" name="gula_darah_sewaktu" class="w-full border px-2 py-1 rounded" placeholder="mg/dL">
          </div>
          <div>
            <label class="block font-semibold mb-1">Tekanan Darah</label>
            <input type="text" name="tekanan_darah" class="w-full border px-2 py-1 rounded" placeholder="mis. 120/80">
          </div>
          <div>
            <label class="block font-semibold mb-1">Cholesterol</label>
            <input type="number" step="any" name="cholesterol" class="w-full border px-2 py-1 rounded" placeholder="mg/dL">
          </div>
          <div>
            <label class="block font-semibold mb-1">Asam Urat</label>
            <input type="number" step="any" name="asam_urat" class="w-full border px-2 py-1 rounded" placeholder="mg/dL">
          </div>
          <div>
            <label class="block font-semibold mb-1">Lingkar Perut (cm)</label>
            <input type="number" step="any" name="lingkar_perut" class="w-full border px-2 py-1 rounded" placeholder="cm">
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Simpan Checkup</button>
        </div>
      </form>
      <p class="mt-2 text-xs text-gray-500">Catatan: jika tanggal tidak diisi, sistem akan menggunakan tanggal hari ini.</p>
  </div>
  {% endif %}

  {% if not view_only %}
  <!-- Tambah Karyawan Content -->
  <div id="tambah-karyawan-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'data_karyawan' or active_subtab != 'tambah' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Tambah karyawan</h2>
      <form method="post" action="{% url 'manager:add_karyawan' %}" class="space-y-4">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold mb-1">Nama</label>
            <input type="text" name="nama" class="w-full border px-2 py-1 rounded" placeholder="Masukkan nama karyawan" required>
          </div>
          <div>
            <label class="block font-semibold mb-1">Jabatan</label>
            <input type="text" name="jabatan" class="w-full border px-2 py-1 rounded" placeholder="Masukkan jabatan" required>
          </div>
          <div>
            <label class="block font-semibold mb-1">Lokasi</label>
            <select name="lokasi" class="w-full border px-2 py-1 rounded" required>
              <option value="">Pilih lokasi</option>
              {% for lokasi in available_lokasi %}
                <option value="{{ lokasi }}">{{ lokasi }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block font-semibold mb-1">Tanggal Lahir</label>
            <input type="date" name="tanggal_lahir" class="w-full border px-2 py-1 rounded">
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Tambah</button>
        </div>
      </form>
  </div>
  {% endif %}

  <!-- History Medical Check Up Content -->
  <div id="history-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'history' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">History Medical Check Up</h2>
      <a href="{% url 'manager:export_checkup_history_by_uid' employee.uid %}" class="inline-flex items-center bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 mb-3">Download seluruh riwayat (XLS)</a>
      <a href="{% url 'manager:export_checkup_history_by_uid_pdf' employee.uid %}" class="inline-flex items-center bg-yellow-600 text-white px-3 py-2 rounded hover:bg-yellow-700 mb-3 ml-2">Download seluruh riwayat (PDF)</a>
      <form method="post" action="{% url 'manager:edit_karyawan' employee.uid %}?submenu=history" class="inline-block ml-2" onsubmit="return confirm('Yakin ingin menghapus SEMUA data checkup untuk karyawan ini? Tindakan ini tidak dapat dibatalkan.');">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_all_checkups">
        <button type="submit" class="inline-flex items-center bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 mb-3">Hapus semua data checkup</button>
      </form>
      {% if history_dashboard and history_dashboard|length > 0 %}
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Lahir</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umur</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BMI</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BMI Category</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Checkup</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lingkar Perut</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gula Darah Puasa</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gula Darah Sewaktu</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cholesterol</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asam Urat</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tekanan Darah</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derajat Kesehatan</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal MCU</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expired MCU</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for row in history_dashboard %}
            <tr id="row-{{ row.checkup_id }}">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ forloop.counter }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.uid }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.nama|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.jabatan|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.lokasi|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tanggal_lahir|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" id="umur-{{ row.checkup_id }}" value="{{ row.umur|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="bmi-{{ row.checkup_id }}" value="{{ row.bmi|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.bmi_category|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" id="tanggal_checkup-{{ row.checkup_id }}" value="{{ row.tanggal_checkup|default:'' }}" placeholder="dd/mm/yy atau yyyy-mm-dd" class="w-32 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="lingkar_perut-{{ row.checkup_id }}" value="{{ row.lingkar_perut|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="gula_darah_puasa-{{ row.checkup_id }}" value="{{ row.gula_darah_puasa|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="gula_darah_sewaktu-{{ row.checkup_id }}" value="{{ row.gula_darah_sewaktu|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="cholesterol-{{ row.checkup_id }}" value="{{ row.cholesterol|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" step="0.01" id="asam_urat-{{ row.checkup_id }}" value="{{ row.asam_urat|default:'' }}" class="w-24 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" id="tekanan_darah-{{ row.checkup_id }}" value="{{ row.tekanan_darah|default:'' }}" class="w-28 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" id="derajat_kesehatan-{{ row.checkup_id }}" value="{{ row.derajat_kesehatan|default:'' }}" class="w-20 border px-2 py-1 rounded" disabled />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.tanggal_MCU|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ row.expired_MCU|default:"-" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if row.status == "Unwell" %}
                  <span class="text-red-600 font-semibold">Unwell</span>
                {% elif row.status == "Well" %}
                  <span class="text-green-600 font-semibold">Well</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if row.checkup_id %}
                  <a href="{% url 'manager:export_checkup_row' employee.uid row.checkup_id %}" class="inline-flex items-center bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" title="Download baris ini">XLS</a>
                  <a href="{% url 'manager:export_checkup_row_pdf' employee.uid row.checkup_id %}" class="inline-flex items-center bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 ml-2" title="Download baris ini (PDF)">PDF</a>
                  <form method="post" action="{% url 'manager:edit_karyawan' employee.uid %}?submenu=history" class="inline-block ml-2" onsubmit="return confirm('Yakin ingin menghapus baris riwayat ini?');">
                    {% csrf_token %}
                    <input type="hidden" name="checkup_id" value="{{ row.checkup_id }}" />
                    <button type="submit" class="inline-flex items-center bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" title="Hapus baris ini">Hapus</button>
                  </form>
                  <button type="button" id="editbtn-{{ row.checkup_id }}" class="inline-flex items-center bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 ml-2" onclick="toggleEditRow('{{ row.checkup_id }}')">Edit</button>
                  <form id="saveform-{{ row.checkup_id }}" method="post" action="{% url 'manager:edit_karyawan' employee.uid %}?submenu=history" class="inline-block ml-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_row" />
                    <input type="hidden" name="checkup_id" value="{{ row.checkup_id }}" />
                    <input type="hidden" name="tanggal_checkup" />
                    <input type="hidden" name="tinggi" />
                    <input type="hidden" name="berat" />
                    <input type="hidden" name="lingkar_perut" />
                    <input type="hidden" name="bmi" />
                    <input type="hidden" name="umur" />
                    <input type="hidden" name="gula_darah_puasa" />
                    <input type="hidden" name="gula_darah_sewaktu" />
                    <input type="hidden" name="cholesterol" />
                    <input type="hidden" name="asam_urat" />
                    <input type="hidden" name="tekanan_darah" />
                    <input type="hidden" name="derajat_kesehatan" />
                    <button type="button" id="savebtn-{{ row.checkup_id }}" class="inline-flex items-center bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 hidden" onclick="submitEditRow('{{ row.checkup_id }}')">Save</button>
                  </form>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="p-4 bg-gray-50 border rounded text-gray-500">
          Belum ada data medical checkup.
        </div>
      {% endif %}
      <script>
        function toggleEditRow(id) {
          var fields = ['umur','bmi','tanggal_checkup','lingkar_perut','gula_darah_puasa','gula_darah_sewaktu','cholesterol','asam_urat','tekanan_darah','derajat_kesehatan','tinggi','berat'];
          fields.forEach(function(f){
            var el = document.getElementById(f+'-'+id);
            if (el) el.disabled = !el.disabled;
          });
          var editBtn = document.getElementById('editbtn-'+id);
          var saveBtn = document.getElementById('savebtn-'+id);
          if (editBtn && saveBtn) {
            if (saveBtn.classList.contains('hidden')) {
              saveBtn.classList.remove('hidden');
              editBtn.classList.add('hidden');
            } else {
              saveBtn.classList.add('hidden');
              editBtn.classList.remove('hidden');
            }
          }
        }
        function submitEditRow(id) {
          var form = document.getElementById('saveform-'+id);
          if (!form) return;
          var map = ['tanggal_checkup','tinggi','berat','lingkar_perut','bmi','umur','gula_darah_puasa','gula_darah_sewaktu','cholesterol','asam_urat','tekanan_darah','derajat_kesehatan'];
          map.forEach(function(f){
            var vis = document.getElementById(f + '-' + id);
            var hid = form.querySelector('input[name="'+f+'"]');
            if (vis && hid) hid.value = vis.value;
          });
          form.submit();
        }
      </script>
    </div>

  <!-- Grafik Content -->
  <div id="grafik-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-4 {% if active_submenu != 'grafik' %}hidden{% endif %}">
      <h2 class="text-xl font-bold mb-3">Grafik Riwayat Medical Check Up</h2>
      <form method="get" class="mb-4 flex items-center gap-2">
        <input type="hidden" name="submenu" value="grafik"/>
        <label class="font-medium">Range Bulan:</label>
        <input type="month" name="start_month" value="{{ grafik_start_month }}" class="border px-2 py-1 rounded">
        <span class="mx-1">s/d</span>
        <input type="month" name="end_month" value="{{ grafik_end_month }}" class="border px-2 py-1 rounded">
        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Terapkan</button>
      </form>
      {% if grafik_chart_html %}
        <div class="w-full overflow-x-auto">
          {{ grafik_chart_html|safe }}
        </div>
      {% else %}
        <div class="p-4 bg-gray-50 border rounded text-gray-500">Belum ada data grafik untuk range ini.</div>
      {% endif %}
  </div>
</div>
{% endblock %}

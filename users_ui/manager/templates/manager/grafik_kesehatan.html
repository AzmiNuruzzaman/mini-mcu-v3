{% load static %}
{% comment %}
Manager Dashboard → Grafik → Grafik Kesehatan (Figma-inspired layout)
- Filters, metric summary cards, Plotly chart
- Threshold highlighting via JS
{% endcomment %}

<div id="grafik-content" class="rounded-xl border border-slate-300 shadow-sm bg-white p-6 {% if grafik_subtab != 'grafik_kesehatan' %}hidden{% endif %}">
  <!-- Header -->
  <div class="flex items-center gap-3 mb-6">
    <div>
      <h2 class="text-xl font-bold text-slate-900">Grafik Riwayat Medical Check Up</h2>
      <p class="text-slate-600 text-sm">Monitor and track employee health metrics over time</p>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="bg-white border shadow-md rounded-lg mb-6 p-4">
    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <input type="hidden" name="submenu" value="grafik"/>
      <input type="hidden" name="subtab" value="grafik_kesehatan"/>

      <!-- Start Month -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-1" for="start-month">Start Month</label>
        <input type="month" name="start_month" id="start-month" value="{{ grafik_start_month }}" class="border px-2 py-1 rounded">
      </div>

      <!-- End Month -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-1" for="end-month">End Month</label>
        <input type="month" name="end_month" id="end-month" value="{{ grafik_end_month }}" class="border px-2 py-1 rounded">
      </div>

      <!-- Employee Selector -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-1" for="uid">Karyawan</label>
        <select name="uid" id="uid" class="border px-2 py-1 rounded">
          <option value="all" {% if request.GET.uid == 'all' or not request.GET.uid %}selected{% endif %}>Semua Karyawan</option>
          {% for emp in available_employees %}
            <option value="{{ emp.uid }}" {% if request.GET.uid == emp.uid %}selected{% endif %}>{{ emp.nama }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Apply Button -->
      <div>
        <button type="submit" class="w-full bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 flex items-center justify-center gap-1">
          Terapkan
        </button>
      </div>
    </form>

    {% if request.GET.uid and request.GET.uid|lower != 'all' %}
      <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded flex items-center gap-2 text-sm">
        {% if selected_employee %}
          Menampilkan data untuk: <span class="font-medium">{{ selected_employee.nama }}</span> ({{ selected_employee.uid }})
        {% else %}
          Menampilkan data untuk UID: <span class="font-medium">{{ request.GET.uid }}</span>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- Metric Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    {% for metric in latest_metrics %}
      <div class="border-2 rounded-lg p-4 shadow-sm cursor-pointer transition-all hover:shadow-md {% if metric.active %}border-blue-500 shadow-lg{% else %}border-slate-200{% endif %}" data-metric="{{ metric.key }}">
        <div class="flex justify-between items-center mb-2">
          <p class="text-xs text-slate-500">{{ metric.key }}</p>
          <span class="text-sm font-medium" style="color: {{ metric.color|default:'#000000'|escape }};">{{ metric.value }}</span>
        </div>
        <p class="text-xs text-slate-400">{{ metric.unit }}</p>
        <div class="mt-2 space-y-1">
          <span class="inline-block px-2 py-0.5 rounded text-xs {% if metric.status_color == 'destructive' %}bg-red-100 text-red-700{% elif metric.status_color == 'warning' %}bg-yellow-100 text-yellow-700{% else %}bg-green-100 text-green-700{% endif %}">
            {{ metric.status }}
          </span>
          <p class="text-xs text-slate-500">Threshold: {{ metric.threshold }} {{ metric.unit }}</p>
          <p class="text-xs text-slate-400">{{ metric.description }}</p>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Plotly Chart -->
  {% if grafik_chart_html %}
    <div id="managerHealthChart" class="w-full h-[600px] mb-6">
      {{ grafik_chart_html|safe }}
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        const grafContainer = document.querySelector('#managerHealthChart .plotly-graph-div');
        if (!grafContainer || typeof Plotly === 'undefined') return;
        // Static thresholds for health metrics (hidden by default)
        const thresholdValues = {
          'Gula Darah Puasa': 126,
          'Gula Darah Sewaktu': 200,
          'Asam Urat': 7,
          'Cholesterol': 200
        };

        // Draw line when a legend item is clicked
        if (typeof grafContainer.on === 'function') {
          grafContainer.on('plotly_legendclick', function(ev){
            try {
              const idx = ev.curveNumber;
              const d = ev.data || (ev.fullData || []);
              const name = (d && d[idx] && d[idx].name) ? d[idx].name : null;
              if (!name) return true;
              const thr = thresholdValues[name];
              const shapes = thr != null
                ? [{ type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: thr, y1: thr, line: { color: 'rgba(239,68,68,0.7)', width: 2, dash: 'dash' } }]
                : [];
              Plotly.relayout(grafContainer, { shapes: shapes });
            } catch(e) {}
            return true;
          });
        }

        // Draw line when a metric card is clicked
        document.querySelectorAll('[data-metric]').forEach(card => {
          card.addEventListener('click', function(){
            const key = this.dataset.metric;
            const thr = thresholdValues[key];
            if (thr == null) return;
            const shape = [{ type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: thr, y1: thr, line: { color: 'rgba(239,68,68,0.7)', width: 2, dash: 'dash' } }];
            Plotly.relayout(grafContainer, { shapes: shape });
          });
        });

        // Keep chart responsive
        window.addEventListener('resize', function(){
          try { Plotly.Plots.resize(grafContainer); } catch(e) {}
        });
      });
    </script>
  {% else %}
    <div class="p-12 text-center bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">
      <p class="text-slate-600">Belum ada data grafik untuk range ini.</p>
      <p class="text-slate-500 text-sm mt-1">Coba sesuaikan filter di atas.</p>
    </div>
  {% endif %}

</div>
